version: 2

jobs:
  build_and_test:
    docker:
      - image: circleci/node:6.10
      - name: localstack
        image: localstack/localstack
        environment:
          LAMBDA_EXECUTOR: docker
          LAMBDA_REMOTE_DOCKER: false
    working_directory: ~/project
    steps:
      - checkout

      - restore_cache:
          keys:
            - dependencies-{{ checksum "lerna.json" }}-{{ checksum "package.json" }}
            - dependencies-

      - run:
          name: Installing Dependencies
          command: |
            yarn install
            yarn ybootstrap

      - save_cache:
          paths:
            - ./node_modules
            - ./cumulus/tasks/discover-pdr/node_modules
            - ./cumulus/tasks/discover-pdrs/node_modules
            - ./cumulus/tasks/discover-granules/node_modules
            - ./cumulus/tasks/discover-s3-granules/node_modules
            - ./cumulus/tasks/hello-world/node_modules
            - ./cumulus/tasks/parse-pdr/node_modules
            - ./cumulus/tasks/pdr-status-check/node_modules
            - ./cumulus/tasks/post-to-cmr/node_modules
            - ./cumulus/tasks/queue-granules/node_modules
            - ./cumulus/tasks/queue-pdrs/node_modules
            - ./cumulus/tasks/run-gdal/node_modules
            - ./cumulus/tasks/sync-granule/node_modules
            - ./cumulus/gibs-ops-api/node_modules
            - ./cumulus/packages/api/node_modules
            - ./cumulus/packages/cmrjs/node_modules
            - ./cumulus/packages/common/node_modules
            - ./cumulus/packages/pvl/node_modules
            - ./cumulus/packages/ingest/node_modules
            - ./cumulus/packages/deployment/node_modules
          key: dependencies-{{ checksum "lerna.json" }}-{{ checksum "package.json" }}

      - setup_remote_docker

      - run:
          name: Setting DOCKERHOST variable
          command: |
            echo 'export DOCKERHOST=$(ifconfig | grep -E "([0-9]{1,3}\.){3}[0-9]{1,3}" | grep -v 127.0.0.1 | awk '{ print $2 }' | cut -f2 -d: | head -n1)' >> $BASH_ENV

      - run:
          name: Running Test
          environment:
            LOCALSTACK_HOST: localstack
            DOCKERHOST: $DOCKERHOST
          command: yarn test

  build_and_publish:
    docker:
      - image: circleci/node:6.10
    working_directory: ~/project
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            yarn install

            # short fix for deployment package missing dependencies during deploy
            cd packages/deployment
            npm install
            cd ~/project

      - run:
          name: Publishing to NPM
          command: |
            echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
            VERSION=$(cat lerna.json | jq .version --raw-output)
            ./node_modules/.bin/lerna publish --skip-git --repo-version $VERSION --yes

workflows:
  version: 2
  build_test_deploy:
    jobs:
      - build_and_test
      - build_and_publish:
          requires:
            - build_and_test
          filters:
            branches:
              only: master 