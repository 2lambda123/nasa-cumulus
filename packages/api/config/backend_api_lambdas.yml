# executeMigrations:
#   handler: index.executeMigrations
#   timeout: 300
#   useElasticSearch: '{{parent.es.name}}'
#   memory: 1024
#   source: 'node_modules/@cumulus/api/dist/'
#   envs:
#     GranulesTable:
#       function: Ref
#       value: GranulesTableDynamoDB
#     FilesTable:
#       function: Ref
#       value: FilesTableDynamoDB
#     ExecutionsTable:
#       function: Ref
#       value: ExecutionsTableDynamoDB
#     PdrsTable:
#       function: Ref
#       value: PdrsTableDynamoDB
#     RulesTable:
#       function: Ref
#       value: RulesTableDynamoDB
#     KinesisInboundEventLogger:
#       function: Ref
#       value: KinesisInboundEventLoggerLambdaFunction
#     system_bucket: '{{parent.system_bucket}}'

# messageConsumer:
#   handler: index.messageConsumer
#   timeout: 100
#   memory: 512
#   source: 'node_modules/@cumulus/api/dist/'
#   envs:
#     RulesTable:
#       function: Ref
#       value: RulesTableDynamoDB
#     CollectionsTable:
#       function: Ref
#       value: CollectionsTableDynamoDB
#     ProvidersTable:
#       function: Ref
#       value: ProvidersTableDynamoDB
#     system_bucket: '{{parent.system_bucket}}'
#     FallbackTopicArn:
#       function: Fn::Sub
#       value: '${kinesisFallbackSns}'

# ScheduleSF:
#   description: 'This lambda function is invoked by scheduled rules created via cumulus API'
#   handler: index.scheduler
#   timeout: 100
#   memory: 512
#   source: 'node_modules/@cumulus/api/dist/'
#   envs:
#     CollectionsTable:
#       function: Ref
#       value: CollectionsTableDynamoDB
#     ProvidersTable:
#       function: Ref
#       value: ProvidersTableDynamoDB
#   namedLambdaDeadLetterQueue: true

CreateReconciliationReport:
  handler: index.createReconciliationReport
  source: 'node_modules/@cumulus/api/dist/'
  useDistributionApi: true
  envs:
    system_bucket: '{{parent.system_bucket}}'
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    GranulesTable:
      function: Ref
      value: GranulesTableDynamoDB
    FilesTable:
      function: Ref
      value: FilesTableDynamoDB
    cmr_provider: '{{parent.cmr.provider}}'
    cmr_client_id: '{{parent.cmr.clientId}}'

# BulkDelete:
#   handler: index.bulkDeleteLambda
#   source: 'node_modules/@cumulus/api/dist/'

# KinesisInboundEventLogger:
#   handler: index.logger
#   timeout: 300
#   memory: 512
#   source: 'node_modules/@cumulus/api/dist/'

# KinesisOutboundEventLogger:
#   handler: index.logger
#   timeout: 300
#   memory: 512
#   source: 'node_modules/@cumulus/api/dist'

ApiEndpoints:
  handler: index.appHandler
  timeout: 20
  memory: '{{parent.api_lambda_memory}}'
  source: 'node_modules/@cumulus/api/dist/'
  apiRole: true
  urs_redirect: 'token'
  useDistributionApi: true
  addLogGroup: true
  useElasticSearch: '{{parent.es.name}}'
  envs:
    EARTHDATA_BASE_URL: '{{parent.urs_url}}'
    EARTHDATA_CLIENT_ID: '{{EARTHDATA_CLIENT_ID}}'
    EARTHDATA_CLIENT_PASSWORD: '{{EARTHDATA_CLIENT_PASSWORD}}'
    OAUTH_PROVIDER: '{{parent.oauth.provider}}'
    AccessTokensTable:
      function: Ref
      value: AccessTokensTableDynamoDB
    AsyncOperationsTable:
      function: Ref
      value: AsyncOperationsTableDynamoDB
    CollectionsTable:
      function: Ref
      value: CollectionsTableDynamoDB
    ExecutionsTable:
      function: Ref
      value: ExecutionsTableDynamoDB
    GranulesTable:
      function: Ref
      value: GranulesTableDynamoDB
    PdrsTable:
      function: Ref
      value: PdrsTableDynamoDB
    ProvidersTable:
      function: Ref
      value: ProvidersTableDynamoDB
    RulesTable:
      function: Ref
      value: RulesTableDynamoDB
    UsersTable:
      function: Ref
      value: UsersTableDynamoDB
    AsyncOperationTaskDefinition:
      function: Ref
      value: AsyncOperationTaskDefinition
    EcsCluster:
      function: Ref
      value: EcsCluster
    system_bucket: '{{parent.system_bucket}}'
    BulkDeleteLambda:
      function: Ref
      value: BulkDeleteLambdaFunctionArn
      # function: Fn::GetAtt
      # array:
      #   - BulkDeleteLambdaFunction
      #   - Arn
    invoke:
      function: Ref
      value: ScheduleSFLambdaFunctionArn
      # function: Fn::GetAtt
      # array:
      #   - ScheduleSFLambdaFunction
      #   - Arn
    invokeArn:
      function: Ref
      value: ScheduleSFLambdaFunctionArn
      # function: Fn::GetAtt
      # array:
      #   - ScheduleSFLambdaFunction
      #   - Arn
    invokeReconcileLambda:
      # function: Ref
      # value: CreateReconciliationReportLambdaFunctionArn
      function: Fn::GetAtt
      array:
        - CreateReconciliationReportLambdaFunction
        - Arn
    messageConsumer:
      function: Ref
      value: messageConsumerLambdaFunctionArn
      # function: Fn::GetAtt
      # array:
      #   - messageConsumerLambdaFunction
      #   - Arn
    KinesisInboundEventLogger:
      function: Ref
      value: KinesisInboundEventLoggerLambdaFunctionArn
      # function: Fn::GetAtt
      # array:
      #   - KinesisInboundEventLoggerLambdaFunction
      #   - Arn
    STSCredentialsLambda: '{{parent.sts_credentials_lambda}}'
    cmr_provider: '{{parent.cmr.provider}}'
    cmr_client_id: '{{parent.cmr.clientId}}'
    cmr_username: '{{parent.cmr.username}}'
    cmr_password:
      function: "Ref"
      value: "CmrPassword"
    TOKEN_SECRET: '{{TOKEN_SECRET}}'
  apiGateway:
    - api: backend
      path: '{proxy+}'
      method: any
