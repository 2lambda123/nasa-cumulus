<!-- To update index.html, Edit this file and then export as html. -->
# In-region Direct S3 Access to Buckets

Cumulus deployment api can be configured to dispense temporary credentials for same-region, read-only, direct S3 access.

## Get Temporary Credentials

You can retrieve temporary S3 credentials at the <code>/s3credentials</code> endpoint when authenticated via earthdata login.

<a href="${process.env.DISTRIBUTION_ENDPOINT}s3credentials" target="_blank">${process.env.DISTRIBUTION_ENDPOINT}s3credentials</a>

<a href="https://nasa.github.io/cumulus-distribution-api/#temporary-s3-credentials" target="_blank">View endpoint documentation for more information.</a>

## Sample Response
The response is your temporary credentials. <a href="https://docs.aws.amazon.com/STS/latest/APIReference/API_Credentials.html" target="_blank">See the AWS Credentials reference</a>.
```
{
  accessKeyId: "AKIAIOSFODNN7EXAMPLE",
  secretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  sessionToken: "LONGSTRINGOFCHARACTERS.../HJLgV91QJFCMlmY8slIEOjrOChLQYmzAqrb5U1ekoQAK6f86HKJFTT2dONzPgmJN9ZvW5DBwt6XUxC9HAQ0LDPEYEwbjGVKkzSNQh/",
  expiration: "2021-01-27 00:50:09+00:00"
}
```



## Using Temporary Credentials

The credentials are generated by AWS Security Token Service <a href="https://docs.aws.amazon.com/STS/latest/APIReference/welcome.html" target="_blank">(AWS STS).</a>

Use these temporary credentials in your code when you generate the s3 service, as in this sample code.

```
const aws = require('aws-sdk');

// Use your credentials returned from the s3credentials endpoint here.
const credentials = {
  accessKeyId: "AKIAIOSFODNN7EXAMPLE",
  secretAccessKey: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  sessionToken: "LONGSTRINGOFCHARACTERS.../HJLgV91QJFCMlmY8slIEOjrOChLQYmzAqrb5U1ekoQAK6f86HKJFTT2dONzPgmJN9ZvW5DBwt6XUxC9HAQ0LDPEYEwbjGVKkzSNQh/",
};

// Use an S3 bucket you wish to access.
const yourBucket = 'a-bucket-in-your-region';

// Create the S3 service using your temporary credentials.
const s3 = new aws.S3({ credentials });

// list the objects in the bucket
const returnValue = s3.listObjectsV2({ Bucket: yourBucket }).promise();
returnValue.then((ret) => {
  ret.Contents.forEach((obj) => console.log(obj.Key));
});
```


## Limits

The credentials dispensed from the <code>/s3credentials</code> endpoint are valid for <b>1 hour</b>.  Your code must handle expired tokens and request new ones as needed for sessions that exceed this 1 hour limit. This is an AWS Limit is due to <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_terms-and-concepts.html" target="_blank">role chaining.</a>

In NGAP these credentials will allow <code>getObject</code> and <code>listBucket</code> on the configured resources.
